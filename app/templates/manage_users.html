{% extends "base.html" %}

{% block title %}Class Sections & Students{% endblock %}

{% block head %}
<style>
    .table-wrapper {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        border-radius: 0.5rem;
        overflow: hidden;
    }
    
    .table thead {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        color: white;
    }
    
    .table th {
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.8rem;
        letter-spacing: 0.5px;
    }
    
    .table tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.03);
    }
    
    .student-id {
        font-family: monospace;
        font-weight: 600;
    }
    
    .drop-zone {
        background-color: #f8f9fa;
        border: 3px dashed #ced4da;
        border-radius: 1rem;
        padding: 2rem;
        text-align: center;
        transition: all 0.3s;
        cursor: pointer;
        margin-bottom: 2rem;
    }
    
    .drop-zone:hover, .drop-zone.active {
        background-color: #e9ecef;
        border-color: var(--primary-color);
    }
    
    .drop-zone-prompt {
        color: #6c757d;
        font-size: 1.5rem;
        margin-bottom: 1rem;
    }
    
    .drop-zone-icon {
        font-size: 3rem;
        color: var(--primary-color);
        margin-bottom: 1rem;
    }
    
    .drop-zone-input {
        display: none;
    }
    
    .drop-zone-thumb {
        width: 100%;
        height: 100%;
        border-radius: 0.5rem;
        overflow: hidden;
        position: relative;
    }
    
    .section-cards {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .section-card {
        flex: 0 0 calc(33.333% - 1rem);
        background: white;
        border-radius: 0.5rem;
        padding: 1.5rem;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        transition: all 0.3s;
        border: 2px solid transparent;
    }
    
    .section-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    }
    
    .section-card.active {
        border-color: var(--primary-color);
        background-color: rgba(var(--primary-rgb), 0.05);
    }
    
    .section-card-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    
    .section-card-count {
        font-size: 0.875rem;
        color: #6c757d;
    }
    
    .section-card-icon {
        font-size: 2rem;
        color: var(--primary-color);
        margin-bottom: 1rem;
    }
    
    .irregular-badge {
        background-color: #ff9800;
    }
    
    .regular-badge {
        background-color: #4caf50;
    }
    
    .form-group {
        margin-bottom: 1rem;
    }
    
    .form-control {
        border-radius: 0.5rem;
    }
    
    .upload-btn {
        border-radius: 0.5rem;
        padding: 0.5rem 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h1>Class Sections & Students</h1>
        <p class="text-muted">Upload class lists and manage student records</p>
    </div>
    <div class="col-md-4 text-end">
        <button class="btn btn-outline-primary ms-2" id="addAdminBtn" type="button">
            <i class="bi bi-person-plus"></i> Add Admin
        </button>
        <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Forms
        </a>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Upload Class Section</h5>
    </div>
    <div class="card-body">
        <p class="card-text">Upload an Excel file with student information. The spreadsheet must include the following columns: <strong>studentID</strong>, <strong>name</strong>, <strong>isRegular</strong>, <strong>gradeLevel</strong>, and <strong>email</strong>.</p>
        
        <form method="POST" action="{{ url_for('auth.manage_users') }}" enctype="multipart/form-data" id="upload-form">
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label for="section_name" class="form-label">Section Name</label>
                    <input type="text" class="form-control" id="section_name" name="section_name" placeholder="e.g., BSCS 2A" required>
                </div>
                
                <div class="col-md-8">
                    <div class="drop-zone" id="drop-zone">
                        <div class="drop-zone-icon">
                            <i class="bi bi-cloud-arrow-up"></i>
                        </div>
                        <div class="drop-zone-prompt">Drag & Drop Excel file here or click to browse</div>
                        <input type="file" name="csv_file" id="csv_file" class="drop-zone-input" accept=".xlsx,.xls" required>
                        <div id="file-name" class="mt-2 text-primary"></div>
                    </div>
                </div>
            </div>
            
            <div class="text-end mt-3">
                <button type="submit" class="btn btn-primary upload-btn">
                    <i class="bi bi-upload"></i> Upload Section
                </button>
            </div>
        </form>
    </div>
</div>

{% if sections %}
<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Class Sections</h5>
    </div>
    <div class="card-body">
        <div class="section-cards">
            <a href="{{ url_for('auth.manage_users') }}" class="section-card {% if not active_section %}active{% endif %}" style="text-decoration: none; color: inherit;">
                <div class="section-card-icon">
                    <i class="bi bi-people"></i>
                </div>
                <div class="section-card-title">All Students</div>
                <div class="section-card-count">{{ students|length }} students</div>
            </a>
            
            {% for section in sections %}
            <div class="section-card {% if active_section == section.name %}active{% endif %}" style="position: relative;">
                <a href="{{ url_for('auth.manage_users', section=section.name) }}" style="text-decoration: none; color: inherit; display: block;">
                    <div class="section-card-icon">
                        <i class="bi bi-file-earmark-person"></i>
                    </div>
                    <div class="section-card-title">{{ section.name }}</div>
                    <div class="section-card-count">{{ section.student_count }} students</div>
                </a>
                <button class="btn btn-sm btn-outline-danger delete-section-btn" 
                        data-section-name="{{ section.name }}" 
                        style="position: absolute; top: 5px; right: 5px; z-index: 10;"
                        title="Delete Section">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<div class="card">
    <div class="card-header bg-primary text-white">
        <div class="row align-items-center">
            <div class="col-md-4">
                <h5 class="mb-0">
                    Student List
                    {% if active_section %}
                        <small class="text-white-50"> - {{ active_section }}</small>
                    {% endif %}
                </h5>
            </div>
            <div class="col-md-4">
                <div class="input-group">
                    <input type="text" id="studentSearch" class="form-control" placeholder="Search students..." aria-label="Search students">
                    <span class="input-group-text bg-light">
                        <i class="bi bi-search"></i>
                    </span>
                </div>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-outline-light ms-2" id="spreadsheetViewBtn" type="button">
                    <i class="bi bi-table"></i> Spreadsheet View
                </button>
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        <div id="bulkActionsToolbar" class="bg-light p-3 border-bottom d-none">
            <div class="d-flex align-items-center">
                <span class="me-3">
                    <span id="selectedCount">0</span> students selected
                </span>
                <button id="generateBulkCodes" class="btn btn-primary btn-sm">
                    <i class="bi bi-envelope-check"></i> Send Verification Emails
                </button>
                <button id="cancelSelection" class="btn btn-outline-secondary btn-sm ms-2">
                    <i class="bi bi-x"></i> Cancel
                </button>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th width="40">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="selectAllStudents">
                            </div>
                        </th>
                        <th>Student ID</th>
                        <th>Full Name</th>
                        <th>Status</th>
                        <th>Grade Level</th>
                        <th>Email</th>
                        <th>Verification Email</th>
                        {% if active_section %}
                            <th>Section</th>
                        {% endif %}
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if students %}
                        {% for student in students %}
                        <tr class="student-row" data-student-id="{{ student.student_id }}" data-student-name="{{ student.fullname }}" data-student-email="{{ student.email }}" data-student-section="{{ student.section or active_section or '' }}" style="cursor: pointer;">
                            <td>
                                <div class="form-check">
                                    <input class="form-check-input student-checkbox" type="checkbox" value="{{ student.student_id }}" data-student-name="{{ student.fullname }}">
                                </div>
                            </td>
                            <td class="student-id">{{ student.student_id }}</td>
                            <td>{{ student.fullname }}</td>
                            <td>
                                <span class="badge {% if student.is_irregular == 'Yes' %}irregular-badge{% else %}regular-badge{% endif %}">
                                    {% if student.is_irregular == 'Yes' %}Irregular{% else %}Regular{% endif %}
                                </span>
                            </td>
                            <td>{{ student.grade_level }}</td>
                            <td>{{ student.email }}</td>
                            <td class="verification-email-cell" data-student-id="{{ student.student_id }}">
                                <div>
                                    {% if student.email %}
                                        <span class="verification-email-status text-muted">Not sent</span>
                                    {% else %}
                                        <span class="verification-email-status text-danger">No email on file</span>
                                    {% endif %}
                                </div>
                                <button class="btn btn-sm btn-outline-primary send-code-btn mt-2" 
                                        data-student-id="{{ student.student_id }}"
                                        data-student-name="{{ student.fullname }}"
                                        data-student-email="{{ student.email or '' }}"
                                        {% if not student.email %}disabled{% endif %}>
                                    <i class="bi bi-envelope-check"></i> Send Code
                                </button>
                            </td>
                            {% if active_section %}
                                <td>{{ student.section }}</td>
                            {% endif %}
                            <td>
                                {% if student.is_irregular == 'Yes' %}
                                    <button class="btn btn-sm btn-outline-primary move-student-btn me-1" 
                                            data-student-id="{{ student.student_id }}" 
                                            data-student-name="{{ student.fullname }}"
                                            data-section-name="{{ student.section or active_section }}"
                                            title="Move Student">
                                        <i class="bi bi-arrow-right"></i>
                                    </button>
                                {% endif %}
                                <button class="btn btn-sm btn-outline-danger delete-student-btn" 
                                        data-student-id="{{ student.student_id }}" 
                                        data-student-name="{{ student.fullname }}"
                                        data-section-name="{{ student.section or active_section }}"
                                        title="Delete Student">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="{% if active_section %}9{% else %}8{% endif %}" class="text-center">
                                <em>No students found</em>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="text-muted mt-3">
    <small>
        <i class="bi bi-info-circle"></i> Students can log in using their student ID as username and the verification code sent to their email as the password.
    </small>
</div>

<!-- Student Verification Modal -->
<div class="modal fade" id="studentModal" tabindex="-1" aria-labelledby="studentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="studentModalLabel">Student Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="student-details mb-4">
                    <div class="row mb-3">
                        <div class="col-md-4 fw-bold">Student ID:</div>
                        <div class="col-md-8" id="modalStudentId"></div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4 fw-bold">Name:</div>
                        <div class="col-md-8" id="modalStudentName"></div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4 fw-bold">Email:</div>
                        <div class="col-md-8" id="modalStudentEmail"></div>
                    </div>
                    <div class="alert alert-info" role="alert">
                        Clicking the button below will generate a new verification code and email it directly to the student.
                    </div>
                </div>
                <div class="d-grid">
                    <button type="button" id="generateVerificationBtn" class="btn btn-primary">
                        <i class="bi bi-envelope-check"></i> Email Verification Code
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Move Student Modal -->
<div class="modal fade" id="moveStudentModal" tabindex="-1" aria-labelledby="moveStudentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="moveStudentModalLabel">Move Student to Different Section</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="student-details mb-4">
                    <div class="row mb-3">
                        <div class="col-md-4 fw-bold">Student ID:</div>
                        <div class="col-md-8" id="moveStudentId"></div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4 fw-bold">Name:</div>
                        <div class="col-md-8" id="moveStudentName"></div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4 fw-bold">Current Section:</div>
                        <div class="col-md-8" id="moveCurrentSection"></div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4 fw-bold">Move to Section:</div>
                        <div class="col-md-8">
                            <select id="moveToSection" class="form-select">
                                <option value="">Select destination section...</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="d-grid">
                    <button type="button" id="confirmMoveBtn" class="btn btn-primary">
                        <i class="bi bi-arrow-right"></i> Move Student
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Admin Modal -->
<div class="modal fade" id="addAdminModal" tabindex="-1" aria-labelledby="addAdminModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addAdminModalLabel">Add New Admin</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addAdminForm">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> A verification code will be sent to the admin's email. They will need to verify their email and create a password to complete registration.
                    </div>
                    <div class="mb-3">
                        <label for="newAdminName" class="form-label">Full Name *</label>
                        <input type="text" class="form-control" id="newAdminName" required placeholder="Enter admin's full name">
                    </div>
                    <div class="mb-3">
                        <label for="newAdminEmail" class="form-label">Email *</label>
                        <input type="email" class="form-control" id="newAdminEmail" required placeholder="Enter admin's email address">
                        <div class="form-text">A verification code will be sent to this email</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmAddAdminBtn">
                    <i class="bi bi-person-plus"></i> Add Admin
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Spreadsheet View Modal -->
<div class="modal fade" id="spreadsheetModal" tabindex="-1" aria-labelledby="spreadsheetModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="spreadsheetModalLabel">
                    <i class="bi bi-table"></i> Student Spreadsheet View
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="padding: 0;">
                <div class="p-3 border-bottom bg-light">
                    <button type="button" class="btn btn-success btn-sm" id="addStudentRowBtn">
                        <i class="bi bi-plus-circle"></i> Add New Row
                    </button>
                    <button type="button" class="btn btn-primary btn-sm ms-2" id="saveSpreadsheetBtn">
                        <i class="bi bi-save"></i> Save Changes
                    </button>
                    <button type="button" class="btn btn-secondary btn-sm ms-2" id="cancelSpreadsheetBtn">
                        <i class="bi bi-x"></i> Cancel
                    </button>
                </div>
                <div class="table-responsive" style="max-height: calc(100vh - 200px); overflow-y: auto;">
                    <table class="table table-bordered table-hover mb-0" id="spreadsheetTable">
                        <thead class="table-light" style="position: sticky; top: 0; z-index: 10; background-color: #f8f9fa !important;">
                            <tr>
                                <th style="width: 120px; background-color: #000000;">Student ID</th>
                                <th style="width: 200px; background-color: #000000;">Full Name</th>
                                <th style="width: 200px; background-color: #000000;">Email</th>
                                <th style="width: 100px; background-color: #000000;">Is Irregular</th>
                                <th style="width: 150px; background-color: #000000;">Section</th>
                                <th style="width: 100px; background-color: #000000;">Grade Level</th>
                                <th style="width: 80px; background-color: #000000;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="spreadsheetTableBody">
                            <!-- Rows will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('csv_file');
        const fileName = document.getElementById('file-name');
        const studentSearch = document.getElementById('studentSearch');
        const studentRows = document.querySelectorAll('.student-row');
        const studentModal = new bootstrap.Modal(document.getElementById('studentModal'));
        const moveStudentModal = new bootstrap.Modal(document.getElementById('moveStudentModal'));
        const generateVerificationBtn = document.getElementById('generateVerificationBtn');
        
        // Initialize modals
        const addAdminModal = new bootstrap.Modal(document.getElementById('addAdminModal'));
        const spreadsheetModal = new bootstrap.Modal(document.getElementById('spreadsheetModal'));
        
        // File Upload Functions
        // ====================
        
        // Prevent default drag behaviors
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });
        
        // Highlight drop zone when dragging over it
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });
        
        // Remove highlight when dragging leaves
        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });
        
        // Handle dropped files
        dropZone.addEventListener('drop', handleDrop, false);
        
        // Click to browse files
        dropZone.addEventListener('click', () => {
            fileInput.click();
        });
        
        // Handle file selection
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length) {
                updateFileNameDisplay(fileInput.files[0]);
            }
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        function highlight() {
            dropZone.classList.add('active');
        }
        
        function unhighlight() {
            dropZone.classList.remove('active');
        }
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length) {
                fileInput.files = files;
                updateFileNameDisplay(files[0]);
            }
        }
        
        function updateFileNameDisplay(file) {
            // Display file name
            const fileExtension = file.name.split('.').pop().toLowerCase();
            
            if (fileExtension !== 'xlsx' && fileExtension !== 'xls') {
                fileName.innerHTML = `<span class="text-danger">Invalid file type. Please select an Excel file (.xlsx or .xls).</span>`;
                return;
            }
            
            fileName.innerHTML = `<i class="bi bi-file-earmark-text me-1"></i> ${file.name}`;
            
            // Update form validation
            fileInput.setCustomValidity('');
        }

        function updateVerificationStatus(studentId, message, statusClass = 'text-muted') {
            const cell = document.querySelector(`.verification-email-cell[data-student-id="${studentId}"]`);
            if (!cell) return;
            const statusSpan = cell.querySelector('.verification-email-status');
            if (!statusSpan) return;
            statusSpan.textContent = message;
            statusSpan.classList.remove('text-muted', 'text-success', 'text-danger');
            statusSpan.classList.add(statusClass);
        }

        function setSendButtonLoading(studentId, isLoading) {
            const cell = document.querySelector(`.verification-email-cell[data-student-id="${studentId}"]`);
            if (!cell) return;
            const button = cell.querySelector('.send-code-btn');
            if (!button) return;
            if (isLoading) {
                button.dataset.originalText = button.innerHTML;
                button.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> Sending...';
                button.disabled = true;
            } else {
                button.innerHTML = button.dataset.originalText || '<i class="bi bi-envelope-check"></i> Send Code';
                const email = button.getAttribute('data-student-email');
                button.disabled = !email;
            }
        }

        function sendVerificationEmail(studentId) {
            updateVerificationStatus(studentId, 'Sending email...', 'text-muted');
            setSendButtonLoading(studentId, true);
            return fetch('/auth/generate-verification-code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ student_id: studentId }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.email_sent) {
                        updateVerificationStatus(studentId, 'Email sent successfully.', 'text-success');
                    } else {
                        updateVerificationStatus(studentId, data.email_error || 'Email not sent.', 'text-danger');
                    }
                } else {
                    updateVerificationStatus(studentId, data.error || 'Failed to send email.', 'text-danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                updateVerificationStatus(studentId, 'Error sending email. Please try again.', 'text-danger');
            })
            .finally(() => {
                setSendButtonLoading(studentId, false);
            });
        }
        
        // Click on student row
        studentRows.forEach(row => {
            row.addEventListener('click', function(e) {
                // Ignore clicks on the checkbox or buttons
                if (e.target.closest('.form-check') || e.target.closest('button')) {
                    return;
                }
                
                const studentId = this.dataset.studentId;
                const studentName = this.dataset.studentName;
                const studentEmail = this.dataset.studentEmail;
                
                // Set modal content
                document.getElementById('modalStudentId').textContent = studentId;
                document.getElementById('modalStudentName').textContent = studentName;
                document.getElementById('modalStudentEmail').textContent = studentEmail || 'No email on file';
                
                if (!studentEmail) {
                    generateVerificationBtn.disabled = true;
                    generateVerificationBtn.innerHTML = '<i class="bi bi-exclamation-circle"></i> No Email Available';
                } else {
                    generateVerificationBtn.disabled = false;
                    generateVerificationBtn.innerHTML = '<i class="bi bi-envelope-check"></i> Email Verification Code';
                }
                
                // Show modal
                studentModal.show();
            });
        });
        
        // Search functionality
        studentSearch.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            
            studentRows.forEach(row => {
                const studentId = row.querySelector('.student-id').textContent.toLowerCase();
                const studentName = row.dataset.studentName.toLowerCase();
                const studentEmail = row.dataset.studentEmail.toLowerCase();
                
                if (studentId.includes(searchTerm) || 
                    studentName.includes(searchTerm) || 
                    studentEmail.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
        
        // Select all students checkbox
        const selectAllCheckbox = document.getElementById('selectAllStudents');
        const studentCheckboxes = document.querySelectorAll('.student-checkbox');
        const bulkActionsToolbar = document.getElementById('bulkActionsToolbar');
        const selectedCountElement = document.getElementById('selectedCount');
        const generateBulkCodesBtn = document.getElementById('generateBulkCodes');
        const cancelSelectionBtn = document.getElementById('cancelSelection');
        
        // Modal verification email
        generateVerificationBtn.addEventListener('click', function() {
            const studentId = document.getElementById('modalStudentId').textContent;
            if (!studentId) return;
            const originalText = generateVerificationBtn.innerHTML;
            generateVerificationBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> Sending...';
            generateVerificationBtn.disabled = true;
            sendVerificationEmail(studentId).finally(() => {
                const hasEmail = document.getElementById('modalStudentEmail').textContent !== 'No email on file';
                generateVerificationBtn.innerHTML = '<i class="bi bi-envelope-check"></i> Email Verification Code';
                generateVerificationBtn.disabled = !hasEmail;
            });
        });
        
        // Select all checkbox
        selectAllCheckbox.addEventListener('change', function() {
            const isChecked = this.checked;
            
            studentCheckboxes.forEach(checkbox => {
                // Only check visible rows
                if (checkbox.closest('tr').style.display !== 'none') {
                    checkbox.checked = isChecked;
                }
            });
            
            updateBulkActionsToolbar();
        });
        
        // Individual checkboxes
        studentCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                updateBulkActionsToolbar();
                
                // Update select all checkbox
                selectAllCheckbox.checked = Array.from(studentCheckboxes)
                    .filter(cb => cb.closest('tr').style.display !== 'none')
                    .every(cb => cb.checked);
            });
        });
        
        // Update bulk actions toolbar
        function updateBulkActionsToolbar() {
            const checkedCount = document.querySelectorAll('.student-checkbox:checked').length;
            
            if (checkedCount > 0) {
                bulkActionsToolbar.classList.remove('d-none');
                selectedCountElement.textContent = checkedCount;
            } else {
                bulkActionsToolbar.classList.add('d-none');
            }
        }
        
        // Cancel selection
        cancelSelectionBtn.addEventListener('click', function() {
            studentCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            
            selectAllCheckbox.checked = false;
            bulkActionsToolbar.classList.add('d-none');
        });
        
        // Send bulk verification emails
        generateBulkCodesBtn.addEventListener('click', function() {
            const selectedStudentIds = Array.from(document.querySelectorAll('.student-checkbox:checked'))
                .map(checkbox => checkbox.value);
            
            if (selectedStudentIds.length === 0) {
                alert('Please select at least one student');
                return;
            }
            
            if (!confirm(`Send verification emails to ${selectedStudentIds.length} selected students?`)) {
                return;
            }
            
            fetch('/auth/generate-bulk-verification-codes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ student_ids: selectedStudentIds }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const failures = [];
                    (data.results || []).forEach(result => {
                        if (result.email_sent) {
                            updateVerificationStatus(result.student_id, 'Email sent successfully.', 'text-success');
                        } else {
                            updateVerificationStatus(result.student_id, result.email_error || 'Email not sent.', 'text-danger');
                            failures.push(result.student_name || result.student_id);
                        }
                    });
                    cancelSelectionBtn.click();
                    if (failures.length) {
                        alert(`Emails sent, but failed for: ${failures.join(', ')}`);
                    } else {
                        alert(`Verification emails sent to ${selectedStudentIds.length} students.`);
                    }
                } else {
                    alert('Error sending verification emails: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error sending verification emails. Please try again.');
            });
        });
        
        // Individual send code buttons
        document.querySelectorAll('.send-code-btn').forEach(button => {
            button.addEventListener('click', function(e) {
                e.stopPropagation(); // Prevent row click
                
                const studentId = this.dataset.studentId;
                sendVerificationEmail(studentId);
            });
        });

        // Spreadsheet View Functionality
        // ==============================
        
        // Note: spreadsheetModal is already initialized above
        let spreadsheetData = [];
        
        // Store active section from template
        const activeSection = '{{ active_section or "" }}';
        
        // Load all students for spreadsheet view
        function loadSpreadsheetData() {
            spreadsheetData = [];
            const currentStudentRows = document.querySelectorAll('.student-row');
            
            if (currentStudentRows.length === 0) {
                console.warn('No student rows found');
                renderSpreadsheetTable();
                return;
            }
            
            currentStudentRows.forEach(row => {
                try {
                    const studentId = row.dataset.studentId;
                    const studentName = row.dataset.studentName;
                    const studentEmail = row.dataset.studentEmail || '';
                    const studentSection = row.dataset.studentSection || '';
                    const badgeElement = row.querySelector('.badge');
                    const isIrregular = badgeElement ? badgeElement.textContent.trim() === 'Irregular' : false;
                    
                    // Get section from data attribute first, then try activeSection, then try table cell
                    let section = studentSection || activeSection;
                    if (!section) {
                        // Fallback: Check if there's a section column (8th or 7th column depending on view)
                        const sectionCell = row.querySelector('td:nth-child(8)') || row.querySelector('td:nth-child(7)');
                        section = sectionCell ? sectionCell.textContent.trim() : '';
                    }
                    
                    // Get grade level (5th column - after checkbox, student_id, name, status)
                    const gradeLevelCell = row.querySelector('td:nth-child(5)');
                    const gradeLevel = gradeLevelCell ? gradeLevelCell.textContent.trim() : '';
                    
                    spreadsheetData.push({
                        id: studentId,
                        name: studentName,
                        email: studentEmail,
                        isIrregular: isIrregular,
                        section: section,
                        gradeLevel: gradeLevel,
                        isNew: false
                    });
                } catch (error) {
                    console.error('Error processing student row:', error);
                }
            });
            renderSpreadsheetTable();
        }
        
        // Render spreadsheet table
        function renderSpreadsheetTable() {
            const tbody = document.getElementById('spreadsheetTableBody');
            tbody.innerHTML = '';
            
            spreadsheetData.forEach((student, index) => {
                const row = createSpreadsheetRow(student, index);
                tbody.appendChild(row);
            });
        }
        
        // Create a spreadsheet row
        function createSpreadsheetRow(student, index) {
            const tr = document.createElement('tr');
            tr.dataset.index = index;
            if (student.isNew) {
                tr.classList.add('table-warning');
            }
            
            tr.innerHTML = `
                <td>
                    <input type="text" class="form-control form-control-sm" 
                           value="${student.id || ''}" 
                           data-field="id" 
                           ${student.isNew ? '' : 'readonly'}
                           required>
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm" 
                           value="${student.name || ''}" 
                           data-field="name" required>
                </td>
                <td>
                    <input type="email" class="form-control form-control-sm" 
                           value="${student.email || ''}" 
                           data-field="email">
                </td>
                <td>
                    <select class="form-select form-select-sm" data-field="isIrregular">
                        <option value="No" ${!student.isIrregular ? 'selected' : ''}>No</option>
                        <option value="Yes" ${student.isIrregular ? 'selected' : ''}>Yes</option>
                    </select>
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm" 
                           value="${student.section || ''}" 
                           data-field="section" 
                           required
                           placeholder="Enter section name">
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm" 
                           value="${student.gradeLevel || ''}" 
                           data-field="gradeLevel">
                </td>
                <td>
                    <button type="button" class="btn btn-sm btn-danger remove-row-btn" title="${student.isNew ? 'Remove row' : 'Delete student'}">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            `;
            
            // Add remove row event listener
            const removeBtn = tr.querySelector('.remove-row-btn');
            removeBtn.addEventListener('click', function() {
                if (student.isNew) {
                    // Remove from array
                    spreadsheetData.splice(index, 1);
                    renderSpreadsheetTable();
                } else {
                    // Mark for deletion
                    const sectionName = student.section || active_section || '';
                    if (confirm(`Are you sure you want to delete student "${student.name}" (${student.id})?`)) {
                        deleteStudentFromSpreadsheet(student.id, sectionName);
                    }
                }
            });
            
            return tr;
        }
        
        // Function to ensure section exists (create if it doesn't)
        function ensureSectionExists(sectionName) {
            if (!sectionName || !sectionName.trim()) {
                return Promise.resolve(false);
            }
            
            return fetch('/auth/ensure-section', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ section_name: sectionName.trim() }),
            })
            .then(response => response.json())
            .then(data => {
                return data.success;
            })
            .catch(error => {
                console.error('Error ensuring section exists:', error);
                return false;
            });
        }
        
        // Add new row to spreadsheet
        document.getElementById('addStudentRowBtn').addEventListener('click', function() {
            spreadsheetData.push({
                id: '',
                name: '',
                email: '',
                isIrregular: false,
                section: '',
                gradeLevel: '',
                isNew: true
            });
            renderSpreadsheetTable();
            // Scroll to bottom
            setTimeout(() => {
                const tbody = document.getElementById('spreadsheetTableBody');
                tbody.scrollTop = tbody.scrollHeight;
            }, 100);
        });
        
        // Save spreadsheet changes
        document.getElementById('saveSpreadsheetBtn').addEventListener('click', function() {
            // Collect data from all rows
            const rows = document.querySelectorAll('#spreadsheetTableBody tr');
            const updatedData = [];
            const newStudents = [];
            const errors = [];
            
            rows.forEach((row, index) => {
                const inputs = row.querySelectorAll('input, select');
                const studentData = {};
                
                inputs.forEach(input => {
                    const field = input.dataset.field;
                    if (field) {
                        if (field === 'isIrregular') {
                            studentData[field] = input.value === 'Yes';
                        } else {
                            studentData[field] = input.value.trim();
                        }
                    }
                });
                
                // Validate required fields
                if (!studentData.id || !studentData.name || !studentData.section) {
                    errors.push(`Row ${index + 1}: Missing required fields (Student ID, Name, or Section)`);
                    return;
                }
                
                const originalStudent = spreadsheetData[index];
                if (originalStudent && originalStudent.isNew) {
                    newStudents.push(studentData);
                } else if (originalStudent) {
                    // Normalize data for comparison
                    const normalizedOriginal = {
                        id: originalStudent.id,
                        name: originalStudent.name,
                        email: originalStudent.email || '',
                        isIrregular: originalStudent.isIrregular,
                        section: originalStudent.section || '',
                        gradeLevel: originalStudent.gradeLevel || ''
                    };
                    const normalizedUpdated = {
                        id: studentData.id,
                        name: studentData.name,
                        email: studentData.email || '',
                        isIrregular: studentData.isIrregular,
                        section: studentData.section || '',
                        gradeLevel: studentData.gradeLevel || ''
                    };
                    
                    // Check if data changed
                    if (JSON.stringify(normalizedOriginal) !== JSON.stringify(normalizedUpdated)) {
                        updatedData.push({
                            original: originalStudent,
                            updated: studentData
                        });
                    }
                }
            });
            
            if (errors.length > 0) {
                alert('Please fix the following errors:\n' + errors.join('\n'));
                return;
            }
            
            // Collect unique sections that need to be created
            const sectionsToCreate = new Set();
            newStudents.forEach(student => {
                if (student.section) {
                    sectionsToCreate.add(student.section);
                }
            });
            updatedData.forEach(update => {
                if (update.updated.section) {
                    sectionsToCreate.add(update.updated.section);
                }
            });
            
            // Ensure all sections exist first
            const sectionPromises = Array.from(sectionsToCreate).map(sectionName => 
                ensureSectionExists(sectionName)
            );
            
            Promise.all(sectionPromises)
                .then(() => {
                    // Save new students
                    let savePromises = [];
                    
                    newStudents.forEach(student => {
                        const promise = fetch('/auth/add-single-student', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                student_id: student.id,
                                fullname: student.name,
                                is_irregular: student.isIrregular,
                                email: student.email,
                                grade_level: student.gradeLevel,
                                section_name: student.section
                            }),
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (!data.success) {
                                throw new Error(data.message || 'Failed to add student');
                            }
                        });
                        savePromises.push(promise);
                    });
                    
                    // Update existing students
                    updatedData.forEach(update => {
                        const promise = fetch('/auth/update-student', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                student_id: update.updated.id,
                                original_section_name: update.original.section,
                                fullname: update.updated.name,
                                is_irregular: update.updated.isIrregular,
                                email: update.updated.email,
                                grade_level: update.updated.gradeLevel,
                                section_name: update.updated.section
                            }),
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (!data.success) {
                                throw new Error(data.message || 'Failed to update student');
                            }
                        });
                        savePromises.push(promise);
                    });
                    
                    // Wait for all saves to complete
                    if (savePromises.length === 0) {
                        alert('No changes to save.');
                        return;
                    }
                    
                    return Promise.all(savePromises);
                })
                .then(() => {
                    const totalChanges = newStudents.length + updatedData.length;
                    alert(`All changes saved successfully! (${newStudents.length} new, ${updatedData.length} updated)`);
                    spreadsheetModal.hide();
                    window.location.reload();
                })
                .catch(error => {
                    alert('Error saving changes: ' + error.message);
                });
        });
        
        // Cancel spreadsheet changes
        document.getElementById('cancelSpreadsheetBtn').addEventListener('click', function() {
            spreadsheetModal.hide();
        });
        
        // Open spreadsheet modal - attach event listener
        const spreadsheetViewBtn = document.getElementById('spreadsheetViewBtn');
        if (spreadsheetViewBtn) {
            // Remove any existing event listeners by cloning the button
            const newBtn = spreadsheetViewBtn.cloneNode(true);
            spreadsheetViewBtn.parentNode.replaceChild(newBtn, spreadsheetViewBtn);
            
            newBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('Spreadsheet view button clicked');
                
                // Check if modal element exists
                const modalElement = document.getElementById('spreadsheetModal');
                if (!modalElement) {
                    console.error('Spreadsheet modal element not found');
                    alert('Error: Spreadsheet modal not found. Please refresh the page.');
                    return;
                }
                
                // Initialize modal if not already initialized
                let modal = bootstrap.Modal.getInstance(modalElement);
                if (!modal) {
                    modal = new bootstrap.Modal(modalElement);
                }
                
                try {
                    if (typeof loadSpreadsheetData === 'function') {
                        loadSpreadsheetData();
                        modal.show();
                    } else {
                        console.error('loadSpreadsheetData function not found');
                        alert('Error: Spreadsheet function not loaded. Please refresh the page.');
                    }
                } catch (error) {
                    console.error('Error opening spreadsheet view:', error);
                    alert('Error loading spreadsheet view: ' + error.message);
                }
            });
        } else {
            console.error('spreadsheetViewBtn not found in DOM');
        }
        
        // Delete student from spreadsheet
        function deleteStudentFromSpreadsheet(studentId, sectionName) {
            if (!sectionName) {
                sectionName = activeSection;
            }
            
            fetch('/auth/delete-student', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    student_id: studentId,
                    section_name: sectionName
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remove from spreadsheet data
                    spreadsheetData = spreadsheetData.filter(s => s.id !== studentId);
                    renderSpreadsheetTable();
                } else {
                    alert('Error deleting student: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting student. Please try again.');
            });
        }

        // Add Admin Functionality
        // =======================
        
        // Note: addAdminModal is already initialized above
        
        // Add event listener for add admin button
        const addAdminBtn = document.getElementById('addAdminBtn');
        if (addAdminBtn) {
            addAdminBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                addAdminModal.show();
            });
        }
        
        // Confirm add admin button
        document.getElementById('confirmAddAdminBtn').addEventListener('click', function() {
            const name = document.getElementById('newAdminName').value.trim();
            const email = document.getElementById('newAdminEmail').value.trim();
            
            // Validate required fields
            if (!name || !email) {
                alert('Please fill in all required fields (Name and Email).');
                return;
            }
            
            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('Please enter a valid email address.');
                return;
            }
            
            // Add admin
            addAdmin(name, email);
        });
        
        // Add admin function
        function addAdmin(name, email) {
            const btn = document.getElementById('confirmAddAdminBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Adding...';
            btn.disabled = true;
            
            fetch('/auth/add-admin', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    name: name,
                    email: email
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Admin added successfully! A verification code has been sent to ' + email);
                    addAdminModal.hide();
                    // Reset form
                    document.getElementById('addAdminForm').reset();
                } else {
                    alert('Error adding admin: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error adding admin. Please try again.');
            })
            .finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }
        
        // Delete Section Functionality
        // ===========================
        
        // Add event listeners for delete section buttons
        document.querySelectorAll('.delete-section-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const sectionName = this.getAttribute('data-section-name');
                if (confirm(`Are you sure you want to delete the section "${sectionName}"? This will also delete all students in this section.`)) {
                    deleteSection(sectionName);
                }
            });
        });
        
        // Delete section function
        function deleteSection(sectionName) {
            fetch('/auth/delete-section', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ section_name: sectionName }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Section deleted successfully!');
                    window.location.reload();
                } else {
                    alert('Error deleting section: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting section. Please try again.');
            });
        }
        
        // Delete Student Functionality
        // ============================
        
        // Add event listeners for delete student buttons
        document.querySelectorAll('.delete-student-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const studentId = this.getAttribute('data-student-id');
                const studentName = this.getAttribute('data-student-name');
                const sectionName = this.getAttribute('data-section-name');
                
                if (confirm(`Are you sure you want to delete student "${studentName}" (${studentId}) from section "${sectionName}"?`)) {
                    deleteStudent(studentId, sectionName);
                }
            });
        });
        
        // Delete student function
        function deleteStudent(studentId, sectionName) {
            fetch('/auth/delete-student', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    student_id: studentId,
                    section_name: sectionName 
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Student deleted successfully!');
                    window.location.reload();
                } else {
                    alert('Error deleting student: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting student. Please try again.');
            });
        }
        
        // Move Student Functionality
        // ==========================
        
        // Add event listeners for move student buttons
        document.querySelectorAll('.move-student-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const studentId = this.getAttribute('data-student-id');
                const studentName = this.getAttribute('data-student-name');
                const currentSection = this.getAttribute('data-section-name');
                
                // Populate modal with student details
                document.getElementById('moveStudentId').textContent = studentId;
                document.getElementById('moveStudentName').textContent = studentName;
                document.getElementById('moveCurrentSection').textContent = currentSection;
                
                // Load available sections
                loadAvailableSections(currentSection);
                
                // Show modal
                moveStudentModal.show();
            });
        });
        
        // Load available sections for dropdown
        function loadAvailableSections(currentSection) {
            fetch('/auth/get-sections')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const select = document.getElementById('moveToSection');
                        select.innerHTML = '<option value="">Select destination section...</option>';
                        
                        data.sections.forEach(section => {
                            if (section !== currentSection) {
                                const option = document.createElement('option');
                                option.value = section;
                                option.textContent = section;
                                select.appendChild(option);
                            }
                        });
                    } else {
                        alert('Error loading sections: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error loading sections. Please try again.');
                });
        }
        
        // Confirm move button
        document.getElementById('confirmMoveBtn').addEventListener('click', function() {
            const studentId = document.getElementById('moveStudentId').textContent;
            const currentSection = document.getElementById('moveCurrentSection').textContent;
            const toSection = document.getElementById('moveToSection').value;
            
            if (!toSection) {
                alert('Please select a destination section.');
                return;
            }
            
            if (confirm(`Are you sure you want to move student "${document.getElementById('moveStudentName').textContent}" from "${currentSection}" to "${toSection}"?`)) {
                moveStudent(studentId, currentSection, toSection);
            }
        });
        
        // Move student function
        function moveStudent(studentId, fromSection, toSection) {
            fetch('/auth/move-student', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    student_id: studentId,
                    from_section: fromSection,
                    to_section: toSection
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Student moved successfully!');
                    moveStudentModal.hide();
                    window.location.reload();
                } else {
                    alert('Error moving student: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error moving student. Please try again.');
            });
        }
    });
</script>
{% endblock %} 