{% extends "base.html" %}

{% block title %}Edit Form: {{ form.title }}{% endblock %}

{% block head %}
<style>
    /* AI Generator styles */
    .ai-generator-btn {
        position: relative;
        margin-top: 20px;
        padding: 15px;
        background: linear-gradient(135deg, #9c57d3, #5a40b0);
        border-radius: 12px;
        color: white;
        text-align: center;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(123, 76, 160, 0.3);
        overflow: hidden;
    }
    
    .ai-generator-btn:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(123, 76, 160, 0.4);
    }
    
    .ai-generator-btn img {
        height: 30px;
        margin-right: 10px;
        filter: drop-shadow(0 0 3px rgba(255, 255, 255, 0.5));
    }
    
    .ai-generator-btn::after {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(
            to right,
            rgba(255, 255, 255, 0) 0%,
            rgba(255, 255, 255, 0.3) 50%,
            rgba(255, 255, 255, 0) 100%
        );
        transform: rotate(30deg);
        animation: shine 3s infinite;
    }
    
    @keyframes shine {
        0% { transform: translateX(-100%) rotate(30deg); }
        100% { transform: translateX(100%) rotate(30deg); }
    }
    
    /* Modal styles */
    .ai-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 1000;
    }
    
    .ai-modal-content {
        position: relative;
        background: white;
        margin: 5% auto;
        padding: 25px;
        border-radius: 12px;
        width: 80%;
        max-width: 600px;
        box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
        animation: modalFadeIn 0.3s ease;
    }
    
    @keyframes modalFadeIn {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .ai-modal-header {
        background: linear-gradient(135deg, #9c57d3, #5a40b0);
        color: white;
        padding: 15px 20px;
        border-radius: 8px 8px 0 0;
        margin: -25px -25px 20px -25px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .ai-modal-header h3 {
        margin: 0;
        font-size: 1.5rem;
    }
    
    .ai-close {
        color: white;
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .ai-close:hover {
        transform: scale(1.2);
    }
    
    .ai-form-group {
        margin-bottom: 20px;
    }
    
    .ai-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
    }
    
    .ai-input {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
        transition: all 0.3s;
    }
    
    .ai-input:focus {
        border-color: #9c57d3;
        box-shadow: 0 0 0 3px rgba(156, 87, 211, 0.2);
        outline: none;
    }
    
    .ai-btn {
        background: linear-gradient(135deg, #9c57d3, #5a40b0);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    
    .ai-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(156, 87, 211, 0.3);
    }
    
    .ai-btn i {
        margin-right: 8px;
    }
    
    .ai-btn-secondary {
        background: linear-gradient(135deg, #6c757d, #495057);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    
    .ai-btn-secondary:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
        background: linear-gradient(135deg, #5a6268, #343a40);
    }
    
    .ai-loading {
        display: none;
        text-align: center;
        padding: 20px;
    }
    
    .ai-loading .spinner {
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top: 4px solid #9c57d3;
        width: 40px;
        height: 40px;
        margin: 0 auto 15px auto;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .ai-result {
        display: none;
        background: #f8f0ff;
        border-left: 4px solid #9c57d3;
        padding: 15px;
        border-radius: 8px;
        margin-top: 20px;
    }
    
    .ai-categories-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
        margin-top: 10px;
    }
    
    .ai-category-checkbox {
        display: flex;
        align-items: center;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }
    
    .ai-category-checkbox:hover {
        background: #e9ecef;
        border-color: #9c57d3;
    }
    
    .ai-category-checkbox input[type="checkbox"] {
        margin-right: 10px;
        width: 18px;
        height: 18px;
        cursor: pointer;
    }
    
    .ai-category-checkbox input[type="checkbox"]:checked + label {
        font-weight: 600;
        color: #9c57d3;
    }
    
    .ai-category-checkbox label {
        cursor: pointer;
        margin: 0;
        flex: 1;
    }
    
    .ai-category-checkbox input[type="checkbox"]:checked {
        accent-color: #9c57d3;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <div class="d-flex align-items-center">
            <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary me-3">
                <i class="bi bi-arrow-left"></i> Back to Forms
            </a>
            <h1 class="mb-0">Edit Form: {{ form.title }}</h1>
        </div>
        <p class="text-muted">{{ form.description or "No description" }}</p>
    </div>
    <div class="col-md-4 text-end">
        <a href="{{ url_for('main.view_form', form_id=form.id) }}" class="btn btn-success">
            <i class="bi bi-eye"></i> Preview Form
        </a>
    </div>
</div>

<div class="row">
    <div class="col-lg-4 mb-4">
        <div class="card sticky-top" style="top: 20px; z-index: 100;">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Add Question</h5>
            </div>
            <div class="card-body">
                <form id="questionForm" method="POST" action="{{ url_for('main.add_question', form_id=form.id) }}">
                    <div class="mb-3">
                        <label for="question_text" class="form-label">Question</label>
                        <textarea class="form-control" id="question_text" name="question_text" rows="2" required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="question_type" class="form-label">Question Type</label>
                        <select class="form-select" id="question_type" name="question_type" required>
                            <option value="" selected disabled>Select question type</option>
                            <option value="multiple_choice">Multiple Choice</option>
                            <option value="identification">Identification</option>
                            <option value="coding">Coding</option>
                            <option value="checkbox">Checkbox (multiple answers)</option>
                            <option value="true_false">True or False</option>
                            <option value="enumeration">Enumeration</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="points" class="form-label">Points</label>
                        <input type="number" class="form-control" id="points" name="points" min="1" value="1" required>
                        <div class="form-text">Number of points this question is worth.</div>
                    </div>
                    
                    <!-- Multiple Choice Options (initially hidden) -->
                    <div id="multipleChoiceOptions" class="mb-3" style="display: none;">
                        <label class="form-label">Options</label>
                        <div class="options-container">
                            <div class="option-item">
                                <input type="text" class="form-control" name="options[]" placeholder="Option 1">
                                <span class="remove-option"><i class="bi bi-x-circle"></i></span>
                            </div>
                        </div>
                        <button type="button" id="addOption" class="btn btn-sm btn-outline-secondary mt-2">
                            <i class="bi bi-plus"></i> Add Option
                        </button>
                        
                        <div class="mt-3">
                            <label for="correct_answer_mc" class="form-label">Correct Answer</label>
                            <select class="form-select" id="correct_answer_mc" name="correct_answer">
                                <option value="" selected disabled>Select correct option</option>
                            </select>
                            <div class="form-text">This will be used to check if the respondent's answer is correct.</div>
                        </div>
                        
                        <div class="mt-3">
                            <label for="sample_code_mc" class="form-label">Sample Code (Optional)</label>
                            <textarea class="form-control code-editor" id="sample_code_mc" name="sample_code" rows="5"></textarea>
                            <div class="form-text">Optional code that will be displayed to the respondent.</div>
                        </div>
                    </div>
                    
                    <!-- Identification Question Fields (initially hidden) -->
                    <div id="identificationFields" class="mb-3" style="display: none;">
                        <label for="correct_answer_id" class="form-label">Correct Answer</label>
                        <input type="text" class="form-control" id="correct_answer_id" name="correct_answer" placeholder="Enter the correct answer">
                        <div class="form-text">This will be used to check if the respondent's answer is correct.</div>
                        
                        <div class="mt-3">
                            <label for="sample_code_id" class="form-label">Sample Code (Optional)</label>
                            <textarea class="form-control code-editor" id="sample_code_id" name="sample_code" rows="5"></textarea>
                            <div class="form-text">Optional code that will be displayed to the respondent.</div>
                        </div>
                    </div>
                    
                    <!-- Coding Question Fields (initially hidden) -->
                    <div id="codingFields" class="mb-3" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label" for="coding_language">Language</label>
                            <select class="form-select" id="coding_language" name="coding_language">
                                <option value="Python" selected>Python</option>
                                <option value="C">C</option>
                                <option value="C++">C++</option>
                                <option value="Java">Java</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="sample_code" class="form-label">Sample Code</label>
                            <div id="sample_code_editor" style="height:220px;border:1px solid #ddd;border-radius:6px;"></div>
                            <textarea class="form-control code-editor" id="sample_code" name="sample_code" rows="5" style="display:none;"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="expected_output" class="form-label">Unit Tests (Admin Only)</label>
                            <div id="unit_tests_editor" style="height:220px;border:1px solid #ddd;border-radius:6px;"></div>
                            <textarea class="form-control" id="expected_output" name="expected_output" rows="6" style="display:none;" placeholder="def test_sum_function():
    assert sum_numbers([1,2,3,4]) == 10
    assert sum_numbers([]) == 0"></textarea>
                            <div class="form-text">These tests will be used to automatically grade student code. Students cannot see this.</div>
                        </div>
                        <div class="mb-3">
                            <label for="hints" class="form-label">Hints (Variable Names)</label>
                            <input type="text" class="form-control" id="hints" name="hints" placeholder="Use 'sum_numbers' as the function name, 'arr' for array parameter">
                            <div class="form-text">Provide hints about required variable/function names. These will be shown to students in the sample code.</div>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="append_to_dataset" name="append_to_dataset" value="1">
                            <label class="form-check-label" for="append_to_dataset">Add this coding problem to dataset (it_olympics_coding.csv)</label>
                        </div>
                    </div>
                    
                    <!-- Checkbox Options (initially hidden) -->
                    <div id="checkboxOptions" class="mb-3" style="display: none;">
                        <label class="form-label">Options</label>
                        <div class="options-container-checkbox">
                            <div class="option-item">
                                <input type="text" class="form-control" name="options[]" placeholder="Option 1">
                                <span class="remove-option"><i class="bi bi-x-circle"></i></span>
                            </div>
                        </div>
                        <button type="button" id="addOptionCheckbox" class="btn btn-sm btn-outline-secondary mt-2">
                            <i class="bi bi-plus"></i> Add Option
                        </button>
                        
                        <div class="mt-3">
                            <label class="form-label">Correct Answers</label>
                            <div id="correct_answers_container" class="form-check-list"></div>
                            <div class="form-text">Select all correct options.</div>
                        </div>
                    </div>
                    
                    <!-- True/False Fields (initially hidden) -->
                    <div id="trueFalseFields" class="mb-3" style="display: none;">
                        <label class="form-label">Correct Answer</label>
                        <select class="form-select" name="correct_answer" id="correct_answer_tf">
                            <option value="True">True</option>
                            <option value="False">False</option>
                        </select>
                        <div class="form-text">True/False questions have fixed options.</div>
                    </div>

                    <!-- Enumeration Fields (initially hidden) -->
                    <div id="enumerationFields" class="mb-3" style="display: none;">
                        <label class="form-label">Correct Answers</label>
                        <textarea class="form-control" name="correct_answer" id="correct_answer_enum" rows="3" placeholder="Enter items separated by commas or new lines"></textarea>
                        <div class="form-text">Provide all acceptable items. Students earn partial credit for correct items.</div>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i> Add Question
                        </button>
                    </div>
                </form>
                
                <!-- AI Question Generator Button -->
                <div class="ai-generator-btn" id="aiGeneratorBtn">
                    <svg width="30" height="30" viewBox="0 0 24 24" fill="white" xmlns="http://www.w3.org/2000/svg" style="margin-right: 10px; filter: drop-shadow(0 0 3px rgba(255, 255, 255, 0.5));">
                        <path d="M12 2C11.0111 2 10.0444 2.29324 9.22215 2.84265C8.3999 3.39206 7.75904 4.17295 7.3806 5.08658C7.00216 6.00021 6.90315 7.00555 7.09607 7.97545C7.289 8.94536 7.76521 9.83627 8.46447 10.5355C9.16373 11.2348 10.0546 11.711 11.0245 11.9039C11.9945 12.0969 12.9998 11.9978 13.9134 11.6194C14.827 11.241 15.6079 10.6001 16.1573 9.77785C16.7068 8.95561 17 7.98891 17 7C17 5.67392 16.4732 4.40215 15.5355 3.46447C14.5979 2.52678 13.3261 2 12 2ZM12 10C11.4067 10 10.8266 9.82405 10.3333 9.49441C9.83994 9.16476 9.45542 8.69623 9.22836 8.14805C9.0013 7.59987 8.94189 6.99667 9.05764 6.41473C9.1734 5.83279 9.45912 5.29824 9.87868 4.87868C10.2982 4.45912 10.8328 4.1734 11.4147 4.05764C11.9967 3.94189 12.5999 4.0013 13.1481 4.22836C13.6962 4.45542 14.1648 4.83994 14.4944 5.33329C14.8241 5.82664 15 6.40666 15 7C15 7.79565 14.6839 8.55871 14.1213 9.12132C13.5587 9.68393 12.7956 10 12 10ZM21 21V20C21 18.1435 20.2625 16.363 18.9497 15.0503C17.637 13.7375 15.8565 13 14 13H10C8.14348 13 6.36301 13.7375 5.05025 15.0503C3.7375 16.363 3 18.1435 3 20V21H5V20C5 18.6739 5.52678 17.4021 6.46447 16.4645C7.40215 15.5268 8.67392 15 10 15H14C15.3261 15 16.5979 15.5268 17.5355 16.4645C18.4732 17.4021 19 18.6739 19 20V21H21Z"/>
                    </svg>
                    <span>Generate Questions with AI</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-8">
        <h3>Questions</h3>
        
        {% if questions %}
            {% for question in questions %}
                <div class="question-card">
                    <div class="d-flex justify-content-between mb-2">
                        <div class="d-flex align-items-center">
                            <span class="badge question-type-badge badge-{{ question.question_type }} me-2">
                                {% if question.question_type == 'multiple_choice' %}
                                    <i class="bi bi-list-check"></i> Multiple Choice
                                {% elif question.question_type == 'identification' %}
                                    <i class="bi bi-input-cursor-text"></i> Identification
                                {% elif question.question_type == 'coding' %}
                                    <i class="bi bi-code-square"></i> Coding
                                {% elif question.question_type == 'checkbox' %}
                                    <i class="bi bi-check2-square"></i> Checkbox
                                {% elif question.question_type == 'true_false' %}
                                    <i class="bi bi-check-circle"></i> True/False
                                {% elif question.question_type == 'enumeration' %}
                                    <i class="bi bi-list-ol"></i> Enumeration
                                {% endif %}
                            </span>
                            <span class="badge bg-info">
                                <i class="bi bi-award"></i> {{ question.points }} point{{ 's' if question.points != 1 else '' }}
                            </span>
                        </div>
                        <div>
                            <a href="{{ url_for('main.edit_question_form', question_id=question.id) }}" class="btn btn-sm btn-outline-primary me-1">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <form action="{{ url_for('main.delete_question', question_id=question.id) }}" method="POST" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to delete this question?')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                    
                    <h5>{{ question.question_text }}</h5>
                    
                    {% if question.question_type == 'multiple_choice' and question.options %}
                        <div class="mt-3">
                            <strong>Options:</strong>
                            <ul class="list-group mt-2">
                                {% for option in question.get_options() %}
                                    <li class="list-group-item {% if option == question.correct_answer %}list-group-item-success{% endif %}">
                                        {{ option }}
                                        {% if option == question.correct_answer %}
                                            <span class="badge bg-success float-end">Correct Answer</span>
                                        {% endif %}
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                        
                        {% if question.sample_code %}
                            <div class="mt-3">
                                <strong>Sample Code:</strong>
                                <pre class="code-editor mt-2">{{ question.sample_code }}</pre>
                            </div>
                        {% endif %}
                    {% elif question.question_type == 'identification' %}
                        {% if question.correct_answer %}
                            <div class="mt-3">
                                <strong>Correct Answer:</strong>
                                <div class="correct-answer">{{ question.correct_answer }}</div>
                            </div>
                        {% endif %}
                        
                        {% if question.sample_code %}
                            <div class="mt-3">
                                <strong>Sample Code:</strong>
                                <pre class="code-editor mt-2">{{ question.sample_code }}</pre>
                            </div>
                        {% endif %}
                    {% elif question.question_type == 'coding' %}
                        {% if question.sample_code %}
                            <div class="mt-3">
                                <strong>Sample Code:</strong>
                                <pre class="code-editor mt-2">{{ question.sample_code }}</pre>
                            </div>
                        {% endif %}
                        
                    {% elif question.question_type == 'checkbox' and question.options %}
                        <div class="mt-3">
                            <strong>Options:</strong>
                            <ul class="list-group mt-2">
                                {% set correct_list = question.get_correct_answers() %}
                                {% for option in question.get_options() %}
                                    <li class="list-group-item {{ option in correct_list and 'list-group-item-success' or '' }}">
                                        {{ option }}
                                        {% if option in correct_list %}
                                            <span class="badge bg-success float-end">Correct Answer</span>
                                        {% endif %}
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% elif question.question_type == 'true_false' %}
                        {% if question.correct_answer %}
                            <div class="mt-3">
                                <strong>Correct Answer:</strong>
                                <span class="badge bg-success">{{ question.correct_answer }}</span>
                            </div>
                        {% endif %}
                    {% elif question.question_type == 'enumeration' %}
                        {% set correct_list = question.get_correct_answers() %}
                        {% if correct_list %}
                            <div class="mt-3">
                                <strong>Correct Items:</strong>
                                <div class="mt-2">
                                    {% for item in correct_list %}
                                        <span class="badge bg-success me-1">{{ item }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}
                    {% endif %}
                </div>
            {% endfor %}
        {% else %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> No questions added yet. Add your first question using the form on the left.
            </div>
        {% endif %}
    </div>
</div>

<!-- AI Question Generator Modal -->
<div id="aiModal" class="ai-modal">
    <div class="ai-modal-content">
        <div class="ai-modal-header">
            <h3><i class="bi bi-lightning"></i> Question Generator</h3>
            <span class="ai-close">&times;</span>
        </div>
        <div id="aiInputForm">
            <div class="ai-form-group">
                <label class="ai-label">Select Topic Categories</label>
                <div class="ai-categories-container">
                    <div class="ai-category-checkbox">
                        <input type="checkbox" id="cat_cybersecurity" value="Cybersecurity">
                        <label for="cat_cybersecurity">Cybersecurity</label>
                    </div>
                    <div class="ai-category-checkbox">
                        <input type="checkbox" id="cat_digital_electronics" value="Digital Electronics">
                        <label for="cat_digital_electronics">Digital Electronics</label>
                    </div>
                    <div class="ai-category-checkbox">
                        <input type="checkbox" id="cat_linux_admin" value="Linux Administration">
                        <label for="cat_linux_admin">Linux Administration</label>
                    </div>
                    <div class="ai-category-checkbox">
                        <input type="checkbox" id="cat_networking" value="Networking">
                        <label for="cat_networking">Networking</label>
                    </div>
                    <div class="ai-category-checkbox">
                        <input type="checkbox" id="cat_robotics" value="Robotics">
                        <label for="cat_robotics">Robotics</label>
                    </div>
                    <div class="ai-category-checkbox">
                        <input type="checkbox" id="cat_android_dev" value="Android App Development">
                        <label for="cat_android_dev">Android App Development</label>
                    </div>
                    <div class="ai-category-checkbox">
                        <input type="checkbox" id="cat_database" value="Database">
                        <label for="cat_database">Database</label>
                    </div>
                    <div class="ai-category-checkbox">
                        <input type="checkbox" id="cat_java" value="Java">
                        <label for="cat_java">Java</label>
                    </div>
                    <div class="ai-category-checkbox">
                        <input type="checkbox" id="cat_csharp" value="C#">
                        <label for="cat_csharp">C#</label>
                    </div>
                    <div class="ai-category-checkbox">
                        <input type="checkbox" id="cat_python" value="Python">
                        <label for="cat_python">Python</label>
                    </div>
                    <div class="ai-category-checkbox">
                        <input type="checkbox" id="cat_webdesign" value="Web Design">
                        <label for="cat_webdesign">Web Design</label>
                    </div>
                    <div class="ai-category-checkbox">
                        <input type="checkbox" id="cat_esports" value="Esports">
                        <label for="cat_esports">Esports</label>
                    </div>
                </div>
                <small class="form-text text-muted">Select one or more categories to generate questions</small>
            </div>
            
            <!-- Hidden fields that appear when categories are selected -->
            <div id="aiGenerationFields" style="display: none;">
                <div class="ai-form-group">
                    <label class="ai-label">Select Question Types</label>
                    <div class="ai-categories-container">
                        <div class="ai-category-checkbox">
                            <input type="checkbox" id="type_multiple_choice" value="multiple_choice">
                            <label for="type_multiple_choice">Multiple Choice</label>
                        </div>
                        <div class="ai-category-checkbox">
                            <input type="checkbox" id="type_identification" value="identification">
                            <label for="type_identification">Identification</label>
                        </div>
                        <div class="ai-category-checkbox">
                            <input type="checkbox" id="type_coding" value="coding">
                            <label for="type_coding">Coding</label>
                        </div>
                        <div class="ai-category-checkbox">
                            <input type="checkbox" id="type_checkbox" value="checkbox">
                            <label for="type_checkbox">Checkbox</label>
                        </div>
                        <div class="ai-category-checkbox">
                            <input type="checkbox" id="type_true_false" value="true_false">
                            <label for="type_true_false">True/False</label>
                        </div>
                        <div class="ai-category-checkbox">
                            <input type="checkbox" id="type_enumeration" value="enumeration">
                            <label for="type_enumeration">Enumeration</label>
                        </div>
                    </div>
                    <small class="form-text text-muted">Select one or more question types</small>
                </div>
                <div class="ai-form-group">
                    <label class="ai-label" for="aiCount">How many questions per category/type?</label>
                    <input type="number" id="aiCount" class="ai-input" value="1" min="1" max="20">
                    <small class="form-text text-muted">Up to 20 questions per combination. Exact duplicates are automatically removed.</small>
                </div>
                <button id="aiGenerateBtn" class="ai-btn">
                    <i class="bi bi-magic"></i> Generate Questions
                </button>
            </div>
            <div class="ai-error-container"></div>
        </div>
        
        <div id="aiLoading" class="ai-loading">
            <div class="spinner"></div>
            <p>Generating your question...</p>
        </div>
        
        <div id="aiResult" class="ai-result">
            <div id="aiQuestionPreview"></div>
            <button id="aiAddQuestion" class="ai-btn">
                <i class="bi bi-plus-circle"></i> Add This Question
            </button>
            <button id="aiAddSelected" class="ai-btn" style="display:none;">
                <i class="bi bi-plus-circle"></i> Add Selected Questions
            </button>
            <button id="aiGenerateAnother" class="ai-btn ai-btn-secondary">
                <i class="bi bi-arrow-clockwise"></i> Generate Again
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Enable/disable all inputs inside sections
        function disableAllSections() {
            $('#multipleChoiceOptions :input, #identificationFields :input, #codingFields :input, #checkboxOptions :input, #trueFalseFields :input, #enumerationFields :input').prop('disabled', true);
        }

        function enableSection(selector) {
            $(selector + ' :input').prop('disabled', false);
        }

        // Show/hide fields based on question type
        $('#question_type').change(function() {
            const questionType = $(this).val();
            
            // Hide all question-specific fields
            $('#multipleChoiceOptions, #identificationFields, #codingFields, #checkboxOptions, #trueFalseFields, #enumerationFields').hide();
            disableAllSections();
            
            // Show fields based on question type
            if (questionType === 'multiple_choice') {
                $('#multipleChoiceOptions').show();
                enableSection('#multipleChoiceOptions');
            } else if (questionType === 'identification') {
                $('#identificationFields').show();
                enableSection('#identificationFields');
            } else if (questionType === 'coding') {
                $('#codingFields').show();
                enableSection('#codingFields');
                // Lazy load Monaco and create editors if not present
                if (window.require && !window.__monacoLoaded) {
                    window.require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' }});
                    window.require(['vs/editor/editor.main'], function() {
                        window.__monacoLoaded = true;
                        
                        // Sample code editor (light theme)
                        window.__monacoEditor = monaco.editor.create(document.getElementById('sample_code_editor'), {
                            value: '',
                            language: ($('#coding_language').val() || 'Python').toLowerCase().replace('c++','cpp'),
                            theme: 'vs-light',
                            minimap: { enabled: false },
                            fontSize: 14,
                            automaticLayout: true
                        });
                        
                        // Unit tests editor (dark theme)
                        window.__unitTestsEditor = monaco.editor.create(document.getElementById('unit_tests_editor'), {
                            value: 'def test_sum_function():\n    assert sum_numbers([1, 2, 3, 4]) == 10\n    assert sum_numbers([]) == 0',
                            language: 'python',
                            theme: 'vs-dark',
                            minimap: { enabled: false },
                            fontSize: 14,
                            automaticLayout: true
                        });
                    });
                }
            } else if (questionType === 'checkbox') {
                $('#checkboxOptions').show();
                updateCheckboxCorrectAnswers();
                enableSection('#checkboxOptions');
            } else if (questionType === 'true_false') {
                $('#trueFalseFields').show();
                enableSection('#trueFalseFields');
            } else if (questionType === 'enumeration') {
                $('#enumerationFields').show();
                enableSection('#enumerationFields');
            }
        });

        // On load, disable all then enable the currently visible section if a value is selected
        disableAllSections();
        const initialType = $('#question_type').val();
        if (initialType === 'multiple_choice') enableSection('#multipleChoiceOptions');
        if (initialType === 'identification') enableSection('#identificationFields');
        if (initialType === 'coding') enableSection('#codingFields');
        if (initialType === 'checkbox') enableSection('#checkboxOptions');
        if (initialType === 'true_false') enableSection('#trueFalseFields');
        if (initialType === 'enumeration') enableSection('#enumerationFields');
        
        // Add option for multiple choice
        $('#addOption').click(function() {
            const optionsCount = $('.option-item').length;
            const newOption = `
                <div class="option-item">
                    <input type="text" class="form-control" name="options[]" placeholder="Option ${optionsCount + 1}">
                    <span class="remove-option"><i class="bi bi-x-circle"></i></span>
                </div>
            `;
            $('.options-container').append(newOption);
            updateCorrectAnswerOptions();
        });
        
        // Remove option for multiple choice
        $(document).on('click', '.remove-option', function() {
            if ($('.option-item').length > 1) {
                $(this).parent().remove();
                
                // Update placeholders
                $('.option-item').each(function(index) {
                    $(this).find('input').attr('placeholder', `Option ${index + 1}`);
                });
                
                updateCorrectAnswerOptions();
            }
        });
        
        // Update correct answer dropdown when options change
        $(document).on('input', 'input[name="options[]"]', function() {
            updateCorrectAnswerOptions();
        });
        
        // Function to update the correct answer dropdown
        function updateCorrectAnswerOptions() {
            const $correctAnswerSelect = $('#correct_answer_mc');
            const currentValue = $correctAnswerSelect.val();
            
            // Clear existing options except the first
            $correctAnswerSelect.find('option:not(:first)').remove();
            
            // Add new options
            $('input[name="options[]"]').each(function(index) {
                const optionValue = $(this).val();
                if (optionValue) {
                    $correctAnswerSelect.append(`<option value="${optionValue}">${optionValue}</option>`);
                }
            });
            
            // Restore selection if possible
            if (currentValue) {
                $correctAnswerSelect.val(currentValue);
            }
        }

        // Handle language change for coding questions
        $('#coding_language').change(function() {
            if (window.__monacoEditor) {
                const lang = $(this).val().toLowerCase().replace('c++', 'cpp');
                monaco.editor.setModelLanguage(window.__monacoEditor.getModel(), lang);
            }
        });

        // On submit, copy Monaco content to hidden textareas so backend receives it
        $('#questionForm').on('submit', function() {
            if (window.__monacoEditor) {
                $('#sample_code').val(window.__monacoEditor.getValue());
            }
            if (window.__unitTestsEditor) {
                $('#expected_output').val(window.__unitTestsEditor.getValue());
            }
        });

        // Add option for checkbox
        $('#addOptionCheckbox').click(function() {
            const optionsCount = $('.options-container-checkbox .option-item').length;
            const newOption = `
                <div class="option-item">
                    <input type="text" class="form-control" name="options[]" placeholder="Option ${optionsCount + 1}">
                    <span class="remove-option"><i class="bi bi-x-circle"></i></span>
                </div>
            `;
            $('.options-container-checkbox').append(newOption);
            updateCheckboxCorrectAnswers();
        });

        // Remove option for checkbox
        $(document).on('click', '.remove-option', function() {
            if ($('.options-container-checkbox .option-item').length > 1) {
                $(this).parent().remove();
                
                // Update placeholders
                $('.options-container-checkbox .option-item').each(function(index) {
                    $(this).find('input').attr('placeholder', `Option ${index + 1}`);
                });
                
                updateCheckboxCorrectAnswers();
            }
        });

        // Keep checkbox correct answers in sync
        $(document).on('input', '#checkboxOptions input[name="options[]"]', function() {
            updateCheckboxCorrectAnswers();
        });

        function updateCheckboxCorrectAnswers() {
            const container = $('#correct_answers_container');
            const current = new Set(container.find('input:checked').map(function(){return $(this).val();}).get());
            container.empty();
            $('#checkboxOptions input[name="options[]"]').each(function() {
                const val = $(this).val();
                if (!val) return;
                const id = 'cb_ca_' + btoa(val).replace(/=/g,'');
                const checked = current.has(val) ? 'checked' : '';
                container.append(`
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="correct_answer[]" value="${val}" id="${id}" ${checked}>
                        <label class="form-check-label" for="${id}">${val}</label>
                    </div>
                `);
            });
        }
        
        // Add animation effects
        $('.question-card').each(function(index) {
            $(this).css('animation-delay', `${index * 0.1}s`);
        });
        
        // AI Generator Modal
        const aiModal = document.getElementById('aiModal');
        const aiGeneratorBtn = document.getElementById('aiGeneratorBtn');
        const closeBtn = document.querySelector('.ai-close');
        const aiGenerateBtn = document.getElementById('aiGenerateBtn');
        const aiInputForm = document.getElementById('aiInputForm');
        const aiLoading = document.getElementById('aiLoading');
        const aiResult = document.getElementById('aiResult');
        const aiAddQuestionBtn = document.getElementById('aiAddQuestion');
        const aiAddSelectedBtn = document.getElementById('aiAddSelected');
        const aiQuestionPreview = document.getElementById('aiQuestionPreview');
        const aiCount = document.getElementById('aiCount');
        const aiGenerationFields = document.getElementById('aiGenerationFields');
        
        // Handle category checkbox clicks to show/hide generation fields
        $('input[type="checkbox"][id^="cat_"]').on('change', function() {
            const checkedCategories = $('input[type="checkbox"][id^="cat_"]:checked').length;
            if (checkedCategories > 0) {
                aiGenerationFields.style.display = 'block';
            } else {
                aiGenerationFields.style.display = 'none';
            }
        });
        
        // Open modal
        aiGeneratorBtn.onclick = function() {
            aiModal.style.display = 'block';
            document.body.style.overflow = 'hidden'; // Prevent scrolling
            aiInputForm.style.display = 'block';
            aiLoading.style.display = 'none';
            aiResult.style.display = 'none';
        }
        
        // Close modal
        closeBtn.onclick = function() {
            aiModal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target == aiModal) {
                aiModal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }
        
        // Fuzzy text normalizer for de-duplication (case-insensitive, strip punctuation/extra spaces)
        function normalizeText(t) {
            // Exact-ish: ignore leading/trailing/multiple spaces and case only
            return (t || '')
                .toLowerCase()
                .replace(/\s+/g, ' ')
                .trim();
        }
        
        // Generate question from datasets
        async function generateQuestionFromDatasets(prompt, questionType) {
            try {
                const response = await fetch('/form/ai-question', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        question_type: questionType,
                    }),
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error generating question from datasets:', error);
                throw error;
            }
        }
        
        // Generate question(s) with AI
        aiGenerateBtn.addEventListener('click', async function() {
            // Get selected categories
            const selectedCategories = [];
            $('input[type="checkbox"][id^="cat_"]:checked').each(function() {
                selectedCategories.push($(this).val());
            });
            
            // Get selected question types
            const selectedTypes = [];
            $('input[type="checkbox"][id^="type_"]:checked').each(function() {
                selectedTypes.push($(this).val());
            });
            
            const count = Math.max(1, Math.min(parseInt(aiCount.value || '1', 10), 20));
            
            if (selectedCategories.length === 0) {
                const errorContainer = document.querySelector('.ai-error-container');
                errorContainer.innerHTML = `
                    <div class="ai-error">
                        <strong>Error:</strong> Please select at least one category
                    </div>
                `;
                return;
            }
            
            if (selectedTypes.length === 0) {
                const errorContainer = document.querySelector('.ai-error-container');
                errorContainer.innerHTML = `
                    <div class="ai-error">
                        <strong>Error:</strong> Please select at least one question type
                    </div>
                `;
                return;
            }
            
            // Clear any previous errors
            const errorContainer = document.querySelector('.ai-error-container');
            errorContainer.innerHTML = '';
            
            // Show loading screen
            aiInputForm.style.display = 'none';
            aiLoading.style.display = 'flex';
            aiAddSelectedBtn.style.display = 'none';
            aiAddQuestionBtn.style.display = 'inline-block';
            
            try {
                const tasks = [];
                // Generate questions for each category and type combination
                for (const category of selectedCategories) {
                    for (const typeValue of selectedTypes) {
                        for (let i = 0; i < count; i++) {
                            const categoryPrompt = `${category} (${i + 1})`;
                            tasks.push(generateQuestionFromDatasets(categoryPrompt, typeValue));
                        }
                    }
                }
                const results = await Promise.allSettled(tasks);
                
                // Dedupe by normalized question text (less aggressive for coding questions)
                const unique = [];
                const seen = new Set();
                results.forEach(r => {
                    if (r.status === 'fulfilled' && r.value && r.value.text) {
                        let key = normalizeText(r.value.text);
                        
                        // For coding questions, include language and topic in deduplication key
                        if (r.value.question_type === 'coding' && r.value.language) {
                            key = `${key}_${r.value.language}_${r.value.topic || ''}`;
                        }
                        
                        if (key && !seen.has(key)) {
                            seen.add(key);
                            unique.push(r.value);
                        }
                    }
                });
                
                // Display the result
                aiLoading.style.display = 'none';
                aiResult.style.display = 'block';
                
                // Store the data for later use
                aiResult.dataset.questionData = unique.length === 1 ? JSON.stringify(unique[0]) : '';
                aiResult.dataset.questionList = unique.length > 1 ? JSON.stringify(unique) : '';
                
                // Create the preview HTML
                let previewHtml = '';
                if (unique.length <= 1) {
                    const data = unique[0];
                    previewHtml += `
                        <div class="ai-question-card">
                            <h4>${data.text}</h4>
                    `;
                    if (data.question_type === 'multiple_choice' && data.options) {
                        previewHtml += '<ul class="ai-options-list">';
                        data.options.forEach(function(option) {
                            const isCorrect = option === data.correct_answer;
                            previewHtml += `
                                <li class="ai-option-item ${isCorrect ? 'correct' : ''}">
                                    ${option}
                                    ${isCorrect ? '<span class="badge bg-success float-end">Correct Answer</span>' : ''}
                                </li>
                            `;
                        });
                        previewHtml += '</ul>';
                        previewHtml += `<p><strong>Correct Answer:</strong> <span class="badge bg-success">${data.correct_answer || 'Not specified'}</span></p>`;
                    } else if (data.question_type === 'identification') {
                        previewHtml += `<p><strong>Correct Answer:</strong> <span class="badge bg-success">${data.correct_answer || 'Not specified'}</span></p>`;
                    } else if (data.question_type === 'coding') {
                        if (data.language) {
                            previewHtml += `<p><strong>Language:</strong> <span class="badge bg-info">${data.language}</span></p>`;
                        }
                        if (data.topic) {
                            previewHtml += `<p><strong>Topic:</strong> <span class="badge bg-secondary">${data.topic}</span></p>`;
                        }
                        if (data.sample_code) {
                            previewHtml += `
                                <div class="mb-3">
                                    <h5>Sample Code:</h5>
                                    <pre class="p-3 bg-light border rounded"><code>${data.sample_code}</code></pre>
                                </div>`;
                        }
                        if (data.expected_output || data.unit_tests) {
                            previewHtml += `
                                <div class="mb-3">
                                    <h5>Unit Tests:</h5>
                                    <pre class="p-3 bg-dark text-light border rounded"><code>${data.expected_output || data.unit_tests}</code></pre>
                                </div>`;
                        }
                    } else if (data.question_type === 'checkbox' && data.options) {
                        const correctList = Array.isArray(data.correct_answer) ? data.correct_answer : [];
                        previewHtml += '<ul class="ai-options-list">';
                        data.options.forEach(function(option) {
                            const isCorrect = correctList.includes(option);
                            previewHtml += `
                                <li class="ai-option-item ${isCorrect ? 'correct' : ''}">
                                    ${option}
                                    ${isCorrect ? '<span class="badge bg-success float-end">Correct</span>' : ''}
                                </li>
                            `;
                        });
                        previewHtml += '</ul>';
                        if (correctList.length) {
                            previewHtml += `<p><strong>Correct Answers:</strong> ${correctList.map(c=>`<span class=\"badge bg-success me-1\">${c}</span>`).join('')}</p>`;
                        }
                    } else if (data.question_type === 'true_false') {
                        previewHtml += `<p><strong>Correct Answer:</strong> <span class="badge bg-success">${data.correct_answer || 'True'}</span></p>`;
                    } else if (data.question_type === 'enumeration') {
                        const list = Array.isArray(data.correct_answer) ? data.correct_answer : [];
                        if (list.length) {
                            previewHtml += `<p><strong>Correct Items:</strong> ${list.map(c=>`<span class=\"badge bg-success me-1\">${c}</span>`).join('')}</p>`;
                        }
                    }
                    previewHtml += '</div>';
                    aiAddSelectedBtn.style.display = 'none';
                    aiAddQuestionBtn.style.display = 'inline-block';
                } else {
                    previewHtml += `<div class="mb-2"><strong>${unique.length}</strong> unique questions generated (duplicates removed):</div>`;
                    unique.forEach((q, idx) => {
                        previewHtml += `
                            <div class="ai-question-card">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="${idx}" id="qsel_${idx}" checked>
                                    <label class="form-check-label" for="qsel_${idx}"><strong>${q.text}</strong></label>
                                </div>
                                ${q.question_type === 'multiple_choice' && q.options ? `
                                    <ul class="ai-options-list">
                                        ${q.options.map(o => `<li class=\"ai-option-item ${o===q.correct_answer ? 'correct' : ''}\">${o}${o===q.correct_answer ? '<span class=\"badge bg-success float-end\">Correct</span>' : ''}</li>`).join('')}
                                    </ul>` : ''}
                                ${q.question_type === 'identification' ? `<p><strong>Correct Answer:</strong> <span class=\"badge bg-success\">${q.correct_answer || 'Not specified'}</span></p>` : ''}
                                ${q.question_type === 'true_false' ? `<p><strong>Correct Answer:</strong> <span class=\"badge bg-success\">${q.correct_answer || 'True'}</span></p>` : ''}
                                ${q.question_type === 'enumeration' ? (() => {
                                    const list = Array.isArray(q.correct_answer) ? q.correct_answer : [];
                                    return list.length ? `<p><strong>Correct Items:</strong> ${list.map(c=>`<span class=\"badge bg-success me-1\">${c}</span>`).join('')}</p>` : '';
                                })() : ''}
                                ${q.question_type === 'checkbox' && q.options ? (() => {
                                    const correctList = Array.isArray(q.correct_answer) ? q.correct_answer : [];
                                    return `<ul class=\"ai-options-list\">${q.options.map(o => `<li class=\"ai-option-item ${correctList.includes(o) ? 'correct' : ''}\">${o}${correctList.includes(o) ? '<span class=\"badge bg-success float-end\">Correct</span>' : ''}</li>`).join('')}</ul>${correctList.length ? `<p><strong>Correct Answers:</strong> ${correctList.map(c=>`<span class=\"badge bg-success me-1\">${c}</span>`).join('')}</p>` : ''}`;
                                })() : ''}
                                ${q.question_type === 'coding' ? `
                                    <div class="mb-2">
                                        <small class="text-muted">Language: <span class="badge bg-primary">${q.language || 'Unknown'}</span> | Topic: <span class="badge bg-secondary">${q.topic || 'Unknown'}</span></small>
                                    </div>
                                    ${q.sample_code ? `
                                        <div class="mb-2">
                                            <h6>Sample Code:</h6>
                                            <pre class="p-2 bg-light border rounded small"><code>${q.sample_code}</code></pre>
                                        </div>
                                    ` : ''}
                                    ${(q.expected_output || q.unit_tests) ? `
                                        <div class="mb-2">
                                            <h6>Unit Tests:</h6>
                                            <pre class="p-2 bg-dark text-light border rounded small"><code>${q.expected_output || q.unit_tests}</code></pre>
                                        </div>
                                    ` : ''}
                                ` : ''}
                            </div>
                        `;
                    });
                    aiAddSelectedBtn.style.display = 'inline-block';
                    aiAddQuestionBtn.style.display = 'none';
                }
                aiQuestionPreview.innerHTML = previewHtml;
            } catch (error) {
                aiLoading.style.display = 'none';
                aiInputForm.style.display = 'block';
                const errorContainer = document.querySelector('.ai-error-container');
                errorContainer.innerHTML = `
                    <div class="ai-error">
                        <strong>Error:</strong> ${error.message || 'Failed to generate questions'}
                        <p class="mt-2 small">Make sure LM Studio is running with the DeepSeek Coder model loaded.</p>
                    </div>
                `;
            }
        });
        
        // Add a single AI-generated question to the form
        aiAddQuestionBtn.addEventListener('click', async function() {
            const questionData = JSON.parse(aiResult.dataset.questionData || '{}');
            if (!questionData || !questionData.text) return;
            
            // Show loading state
            aiAddQuestionBtn.disabled = true;
            aiAddQuestionBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Adding...';
            
            try {
                await submitQuestion(questionData);
                
                // Show success message and options
                aiAddQuestionBtn.innerHTML = '<i class="bi bi-check-circle"></i> Question Added!';
                aiAddQuestionBtn.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
                
                // Add a "View Form" button temporarily
                const viewFormBtn = document.createElement('button');
                viewFormBtn.className = 'ai-btn ai-btn-secondary ms-2';
                viewFormBtn.innerHTML = '<i class="bi bi-eye"></i> View Form';
                viewFormBtn.onclick = () => {
                    aiModal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                    window.location.reload();
                };
                aiAddQuestionBtn.parentNode.insertBefore(viewFormBtn, aiAddQuestionBtn.nextSibling);
                
                // Auto-close after 3 seconds if user doesn't click
                setTimeout(() => {
                    if (aiModal.style.display !== 'none') {
                        aiModal.style.display = 'none';
                        document.body.style.overflow = 'auto';
                        window.location.reload();
                    }
                }, 3000);
                
            } catch (error) {
                console.error('Error adding question:', error);
                // Reset button state
                aiAddQuestionBtn.disabled = false;
                aiAddQuestionBtn.innerHTML = '<i class="bi bi-plus-circle"></i> Add This Question';
                aiAddQuestionBtn.style.background = 'linear-gradient(135deg, #9c57d3, #5a40b0)';
            }
        });
        
        // Generate again with same inputs
        document.getElementById('aiGenerateAnother').addEventListener('click', function() {
            // Show input form again with current values intact
            aiInputForm.style.display = 'block';
            aiResult.style.display = 'none';
            // Trigger generation with current inputs
            aiGenerateBtn.click();
        });
        
        // Add selected questions (batch)
        aiAddSelectedBtn.addEventListener('click', function() {
            const list = JSON.parse(aiResult.dataset.questionList || '[]');
            if (!Array.isArray(list) || list.length === 0) return;
            // Get selected indices
            const selected = [];
            list.forEach((q, idx) => {
                const cb = document.getElementById(`qsel_${idx}`);
                if (cb && cb.checked) selected.push(q);
            });
            if (selected.length === 0) return;
            // Submit sequentially
            (async function submitAll() {
                for (const q of selected) {
                    await submitQuestion(q);
                }
                // Close modal after adding
                aiModal.style.display = 'none';
                document.body.style.overflow = 'auto';
                // Reload to show new questions
                window.location.reload();
            })();
        });
        
        function submitQuestion(questionData) {
            return new Promise(async (resolve) => {
                try {
                    const fd = new FormData();
                    const addField = (k, v) => fd.append(k, v == null ? '' : v);
                    addField('question_text', questionData.text || '');
                    addField('question_type', questionData.question_type || 'multiple_choice');
                    addField('points', '1');
                    if (questionData.correct_answer) addField('correct_answer', questionData.correct_answer);
                    if (questionData.question_type === 'multiple_choice' && Array.isArray(questionData.options)) {
                        questionData.options.forEach(o => fd.append('options[]', o));
                    }
                    if (questionData.question_type === 'coding') {
                        if (questionData.sample_code) addField('sample_code', questionData.sample_code);
                        // Prefer unit_tests over expected_output for unit test field
                        if (questionData.unit_tests) {
                            addField('expected_output', questionData.unit_tests);
                        } else if (questionData.expected_output) {
                            addField('expected_output', questionData.expected_output);
                        }
                        if (questionData.language) addField('coding_language', questionData.language);
                        if (questionData.hints) addField('hints', questionData.hints);
                    }
                    if (questionData.question_type === 'checkbox') {
                        if (Array.isArray(questionData.options)) {
                            questionData.options.forEach(o => fd.append('options[]', o));
                        }
                        if (Array.isArray(questionData.correct_answer)) {
                            questionData.correct_answer.forEach(ca => fd.append('correct_answer[]', ca));
                        }
                    }
                    if (questionData.question_type === 'true_false') {
                        // Ensure correct_answer is either "True" or "False"
                        let ca = (questionData.correct_answer || '').toString().toLowerCase();
                        if (['true','t','1','yes'].includes(ca)) addField('correct_answer', 'True');
                        else if (['false','f','0','no'].includes(ca)) addField('correct_answer', 'False');
                        else if (ca) addField('correct_answer', questionData.correct_answer);
                    }
                    if (questionData.question_type === 'enumeration') {
                        if (Array.isArray(questionData.correct_answer)) {
                            questionData.correct_answer.forEach(item => fd.append('correct_answer[]', item));
                        } else if (typeof questionData.correct_answer === 'string') {
                            addField('correct_answer', questionData.correct_answer);
                        }
                    }
                    await fetch(`/form/{{ form.id }}/question/new`, { method: 'POST', body: fd });
                } catch (e) {
                    console.error('Add question error', e);
                } finally {
                    resolve();
                }
            });
        }
    });
</script>
{% endblock %}